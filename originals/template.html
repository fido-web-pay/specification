<!DOCTYPE html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="images/favicon.png" sizes="192x192">
<title>FIDO Web Pay</title><style type="text/css">
.header {font-size:1.6em;margin:1em 0 0.8em 0}
.step {font-size:1.2em;color:indigo;margin-top:1.5em;margin-bottom:0.6em}
.para {margin-top: 0.8em}
.actor {color:darkgreen;font-weight:500}
.msg {font-weight:500}
.comment {padding:0.5em 1em;margin-top:1.5em;display:inline-block;background-color:floralwhite}
.box {box-shadow: 0.2em 0.2em 0.2em #d0d0d0;border-width:1px;border-style:solid;border-color:black}
.numbox {border-width:1pt;border-style:solid;border-color:black;border-radius:0.3em;display:inline-block;margin-right:0.6em;padding:0 3pt}
.tftable {border-collapse:collapse;box-shadow:0.2em 0.2em 0.2em #d0d0d0;margin:0.6em 0 1em 0}
.tftable td {background-color: floralwhite;padding: 0.4em 0.5em;border-width: 1px;border-style: solid; border-color: black}
.tftable th {font-weight: normal;padding: 0.4em 0.5em;background-color: #f8f8f8;text-align: center;border-width: 1px;border-style: solid; border-color: black}
.json {word-break:break-all;background-color:#f8f8f8;padding:1em;border-width:1px;border-style:solid;border-color:#a9a9a9;box-shadow:0.3em 0.3em 0.3em #d0d0d0}
body {margin:1em;font-size:10pt;font-family:Roboto,Verdana,"Bitstream Vera Sans","DejaVu Sans",Arial,"Liberation Sans";background-color:white}
code {font-family:"Noto Mono",monospace;color:maroon;font-weight:bolder}
kbd {font-family: "Noto Mono",monospace;font-weight:bolder}
pre {font-family:"Noto Mono",monospace;margin: 0.8em 0 1em 0;padding:0.6em 1em;overflow-x:auto;background-color: #f8f8f8}
ul {margin: 0;padding-left:2em}
li {margin-top:0.3em}
a {color:#4366bf;text-decoration:none;font-weight:500}
</style>
</head>
<body>
  <img style="max-width:50%" src="images/fwp.svg" alt="logo" title="FWP logotype">
  <div id="introduction" class="header">Introduction</div>
  <div>
    <a href="https://www.emvco.com/" title="EMVCo Site">EMV&reg;<img src="images/xtl.svg" alt="link"></a> represents
    the current &quot;Gold Standard&quot; for <i>secure and convenient payments</i>
    in the physical world.
  </div>
  <div class="para">
    This document describes FIDO&reg; Web Pay (FWP), which is a Web-adapted version of EMV,
    building on the technology underpinning <a href="https://fidoalliance.org/fido2/"
                             title="FIDO2 Technology">FIDO2<img src="images/xtl.svg" alt="link"></a>
    combined with the W3C
    <a href="https://www.w3.org/TR/payment-request/"
       title="PaymentRequest">PaymentRequest<img src="images/xtl.svg" alt="link"></a> API.
  </div>
  <div class="para">
    Through an extension to EMV, FWP can be applied to <i>any account-based payment system</i>,
    including the eurozone"s
    <a href="https://www.europeanpaymentscouncil.eu/"
       title="European Payments Council">SEPA Instant<img src="images/xtl.svg" alt="link"></a>.
  </div>
  <div class="para">
     Apart from obvious data format differences (JSON/JavaScript versus ISO7816), the primary technical
enhancement to EMV, is that the FWP client <i>encrypts</i> user-authorizations
in order to accomplish the following subgoals:
  <ul>
    <li>
      Eliminate dependencies on external tokenization services.
    </li>
    <li>
      Limit the amount of personally identifiable information (PII), shared
      with <i>third parties</i>, to the name of the user"s bank.
      This is presumably compliant with
      <a href="https://www.pcisecuritystandards.org"
         title="PCI Site">PCI<img src="images/xtl.svg" alt="link"></a>
      requirements as well as with <a href="https://gdprinfo.eu/"
title="GDPR Site">GDPR<img src="images/xtl.svg" alt="link"></a>.
    </li>
    <li>
      Separate the formats for account numbers and issuer (bank branch) identifiers.
      The latter should preferably be expressed as URLs, removing the need for externally managed
      databases holding issuer payment processor end-points.
    </li>
  </ul>
</div>
  <div id="scope" class="header">
    Scope
  </div>
  <div>
    Note that FWP is not a payment system, it is a <i>payment authorization</i> scheme,
    exclusively dealing with the <i>user"s</i> part of the payment process.
    That is, the backend infrastructure and associated APIs are out of scope for this specification
    and are therefore only described at a &quot;conceptual&quot; level.
    Note though that regardless of the backend design, FWP assertions
    MUST (due to the EMV <i>end-2-end security model</i>),
    always be routed back to the designated issuer &quot;verbatim&quot;
    (together with other required data) in order to initiate a payment transaction.
  </div>
  <div class="para">
    It is assumed that <i>at this stage in time</i>,
    backend infrastructures will be <i>independently defined</i> by each payment network
    rather than becoming a unified standard.  See also <a href="#integration">Integration</a>.
  </div>
  <div id="terminology" class="header">
    Terminology
  </div>
  <div>
    Throughout the rest of this document, actor names are
    written as <span class="actor">Actor Name</span>.
    The <span class="actor">Browser</span> actor is in this specification
    considered to be equivalent to &quot;User Agent&quot;.
    An <span class="actor">Acquirer</span> is in this specification
    denoting any service or network acting as a <i>trusted intermediary</i> between
    a <span class="actor">Merchant</span> and an <span class="actor">Issuer</span>.
  </div>
  <div id="prerequisites" class="header">
    Prerequisites
  </div>
  <div>
    The steps outlined in <a href="#operation">Detailed Operation</a>
    depend on that the <span class="actor">User</span> already has received
    one or more <i>payment credentials</i>
    (&quot;Virtual Cards&quot;) in an <a href="#enrollment">Enrollment</a> process.
    A payment credential is supposed to at least contain the following elements:
    <ul>
      <li>An identifier to a <span class="actor">User</span> specific (<i>unique</i>) FIDO key for <i>signing</i> payment authorization data.</li>
      <li>A JOSE-compliant <code class="reserved">signatureAlgorithm</code> for FWP <a href="#seq-4.4">Signatures</a>.</li>
      <li>
        A <code class="reserved">encryptionKey</code> holding an
        <span class="actor">Issuer</span> specific (<i>shared</i>) public key in JWK
        (<a href="https://tools.ietf.org/html/rfc7517"
            title="JWK/RFC7517">RFC7517<img src="images/xtl.svg" alt="link"></a>)
        format for FWP <a href="#seq-4.5">Encryption</a>.
      </li>
      <li>A JOSE-compliant <code class="reserved">contentEncryptionAlgorithm</code> for FWP <a href="#seq-4.5">Encryption</a>.</li>
      <li>A JOSE-compliant <code class="reserved">keyEncryptionAlgorithm</code> for FWP <a href="#seq-4.5">Encryption</a>.</li>
      <li>An <code class="reserved">accountId</code> associated with the FIDO signature key.</li>
      <li>A <code class="reserved">paymentMethod</code> URL identifying the FWP method for a particular payment network.</li>
      <li>
        An <code class="reserved">issuerId</code> in the form of a
        Bank Identification Number (BIN) or URL associated with the <span class="actor">Issuer</span>.
      </li>
      <li>An icon identifying the payment credential for the <span class="actor">User</span>.</li>
    </ul>
  </div>
  <div class="para box comment">
    Note that FWP effectively forms a browser-resident &quot;Wallet&quot;,
    holding an arbitrary number of payment credentials, each representing a specific <span class="actor">Issuer</span>
    and <code class="reserved">paymentMethod</code>.
  </div>
  <div id="enrollment" class="header">
    Enrollment
  </div>
  <div>
    The exact enrollment process is yet to be defined; the assumption is that it
    could be accomplished by extending the existing W3C
    <a href="https://www.w3.org/TR/webauthn-2/" 
title="Web Authentication">Web&nbsp;Authentication<img src="images/xtl.svg" alt="link"></a> enrollment system.
    The extension would enable the <span class="actor">Browser</span> 
to securely distinguish between &quot;ordinary&quot; FIDO keys,
    and those targeted for payments which is required for maintaining
 a <i>database</i> in the <span class="actor">Browser</span> holding FWP credentials.
  </div>
  <div class="para">
    It would be great if the enrollment system could handle
  <i>multiple credentials in a single operation</i>, because an <span class="actor">Issuer</span> may want to
    support an International card network as well as a national or regional payment network &#x1f609;
  </div>
  <div class="para">
    It MAY be technically feasible using a FIDO key associated with an FWP credential
for Web Authentication as well, but this would be a deployment decision
by the <span class="actor">Issuer</span>.
  </div>
 <div id="operation" class="header">
    Detailed Operation
  </div>
  <div>This section describes the different steps needed to authorize a payment operation using FWP.
The foundation for the description is the following sequence diagram where each step
is linked to a <i>clickable</i> number in a box:
</div>
  <div style="overflow-x:auto;padding:8pt 0">
    @sequencediagram@
  </div>
<div>Note that this specification does not elaborate on the return data from
the <b class="actor">Acquirer</b> and <b class="actor">Issuer</b>,
 because this is payment network specific.</div>
<div class="step"><div id="seq-1" class="numbox">1</div>Initiate PaymentRequest</div>
<div>
  At this point the <b class="actor">User</b> is assumed to have clicked on
  a &quot;Buy&quot; button (after first having selected an FWP compliant payment method),
  causing a <b class="actor">Merchant</b> Web page to invoke 
  the <code>doPaymentRequest()</code> method:
</div>
<pre class="box">
// FWP sample code

const methodData = [{
  supportedMethods: "fido-web-pay",
  data: {
    payee: "Space Shop",  // Shown in the UI
    networks: [{
      name: "https://emvco.com/fwp/mastercard"
    },{
      name: "https://emvco.com/fwp/visa"
    },{
      name: "https://europeanpaymentsinitiative.eu/fwp",
      networkData: "additional stuff..."
    }]
  }
}];

const request = new PaymentRequest(methodData,{
  id: "7040566321",   // Mandatory for FWP
  total: {label: null, amount: {currency: "EUR", value: "435.00"}}
});

async function doPaymentRequest() {
  const response = await request.show();
  await response.complete("success");
  return response.details;
}
</pre>
<div>
  When the <code>show()</code> method is invoked, the <span class="actor">Browser</span>
  (FWP implementation) MUST perform the the following checks:
  <ul>
    <li>
      There is an accompanying <code>data</code> property holding a
      <i>JSON-serializable</i> JavaScript <kbd>Object</kbd> type.
    </li>
    <li>
      The <code>data</code> object contains a <code>payee</code>
      property holding a <i>non-empty</i> JavaScript <kbd>String</kbd> argument.
    </li>
    <li>
      The <code>data</code> object contains a <code>networks</code>
      property holding a <i>non-empty</i> JavaScript <kbd>Array</kbd> argument.
    </li>
    <li>
      That each element in the <code>networks</code> array holds a
      <i>JSON-serializable</i> JavaScript <kbd>Object</kbd> type.
    </li>
    <li>
      That each element in the <code>networks</code> array contains a <code>name</code>
      property holding a <i>non-empty</i> JavaScript <kbd>String</kbd> argument.
    </li>
    <li>
      That none of the elements in the <code>networks</code> array contain other
      elements, with the exception of an <i>optional</i> <code>networkData</code>
      property holding arbitrary JavaScript data.
    </li>
    <li>
      There is only <i>one</i> <code>PaymentItem</code> and it has a
      <code>label</code> property with the argument <kbd>null</kbd>.
    </li>
    <li>
      There is a <i>non-empty</i> <code>id</code> argument included in the
      <code>details</code> parameter to the <code>PaymentRequest</code> constructor.
    </li>
  </ul>
</div>
<div class="para">Any deviations MUST throw an exeption.</div>
<div class="para">Note that the <code>name</code> properties in the <code>networks</code>
array denote the actual payment methods, corresponding to the <code>paymentMethod</code>
property in <a href="#prerequisites">FWP credentials</a>.</div>
<div class="para">
  Note that the <code>canMakePayment()</code> method MUST return <kbd>true</kbd>
if the <span class="actor">User</span> have one or more FWP credentials,
regardless if they match the associated <code>PaymentRequest</code> list or not;
else it MUST return <kbd>false</kbd>.
</div>
<div class="step"><div id="seq-2" class="numbox">2</div>Show Payment Authorization UI</div>
  <div style="margin-bottom:0.8em">
    After a successful invocation of the <code>show()</code>
    method, the <b class="actor">Browser</b> responds with
    a payment authorization UI like the following:
  </div>
  <div style="overflow-x:auto;padding-bottom:5pt">
    <img style="display:block;width:220pt;box-shadow:2pt 2pt 3pt #808080;border-width:1pt;border-style:solid;border-color:darkgrey" alt="Payment UI" src="images/ui.svg">
  </div>
  <div>Non-normative UI in &quot;dark mode&quot;.</div>
  <div class="para">
    If the <b class="actor">User</b> have no matching payment credentials,
    the <b class="actor">Browser</b> MUST indicate that and give the <b class="actor">User</b>
    an option to return to the <b class="actor">Merchant</b> &quot;Checkout&quot; page.
  </div>
  <div class="para">
    If the <b class="actor">User</b> have multiple matching payment credentials,
    the <b class="actor">Browser</b> MUST provide a way to select a specific credential.
    In the sample UI shown above, the <b class="actor">User</b>
    can swipe credentials to the left and right, while arrow symbols are used to show if there
    are more credentials available.  That is, if there is no left arrow, the credential selector is
    at the left end point.
  </div>
<div class="step"><div id="seq-3" class="numbox">3</div>Perform User Authorization</div>
<div>
At this point the <b class="actor">User</b>
<i>authorizes</i> the request with a fingerprint, PIN, or similar.
A successful user authorization causes the next step to be performed.
</div>
<div class="step"><div id="seq-4" class="numbox">4</div>Create FWP Assertion</div>
<div>
At this point the <b class="actor">Browser</b>
creates an FWP assertion which requires the following steps to be performed:
</div>
<div id="seq-4.1" class="step">4.1 Extract PaymentRequest Core Data (PRCD)</div>
<div class="para">
  Create a JSON object representing the core payment request data supplied
  by the <b class="actor">Merchant</b>.  For the sample code this should
  result in the following object:
</div>
<pre class="box">
{
  "id": "7040566321",
  "payee": "Space Shop",
  "amount": {
    "currency": "EUR",
    "value": "435.00"
  }
}
</pre>
<div>Description:</div>
<table class="tftable">
<tr><th>Element</th><th>Comment</th></tr>
<tr><td><code>id</code></td><td><b class="actor">Merchant</b> transaction ID. Copy of of details.id</td></tr>
<tr><td><code>payee</code></td><td><b class="actor">Merchant</b> common name</td></tr>
<tr><td><code>amount</code></td><td>Amount of money requested by the <b class="actor">Merchant</b></td></tr>
</table>
<div>
  This object is subsequently referred to as PaymentRequest Core Data (PRCD).
</div>
<div id="seq-4.2" class="step">4.2 Create a Hash of PaymentRequest Core Data (PRCD)</div>
<div class="para">
  Calculate a Base64Url-encoded SHA256 hash of PRCD, canonicalized according to
  <a href="https://tools.ietf.org/html/rfc8785"
      title="JCS/RFC8785">RFC8785<img src="images/xtl.svg" alt="link"></a>.
  The resulting string is subsequently referred to as PRCDHASH.
</div>
<div class="para">
  Expressed as a formula: PRCDHASH = BASE64URL(SHA256(RFC8785(PRCD))).
</div>
<div class="para">
  Applied to the sample data, this operation should return "-5AfYJfNayqcxJs2nqkUm7EKKLS1oPumgWNWc1BCPuQ".
</div>
<div id="seq-4.3" class="step">
  4.3 Create Authorization Data (AD)
</div>
<div class="para">
  Create a JSON object representing the data to authorize.
  For the sample code this should result in the following object:
</div>
<pre class="box">
{
  "requestHash": {
    "algorithm": "S256",
    "value": "-5AfYJfNayqcxJs2nqkUm7EKKLS1oPumgWNWc1BCPuQ"
  },
  "payeeHost": "spaceshop.com",
  "accountId": "FR7630002111110020050014382",
  "paymentMethod": "https://europeanpaymentsinitiative.eu/fwp",
  "networkData": "additional stuff...",
  "userAuthorizationMethod": "FINGERPRINT",
  "platformData": {
    "operatingSystem": {
      "name": "Android",
      "version": "10"
    },
    "userAgent": {
      "name": "Chrome",
      "version": "95"
    }
  },
  "timeStamp": "2021-03-09T10:32:35+01:00"
}
</pre>
<div>Description:</div>
<table class="tftable">
<tr><th>Element</th><th>Comment</th></tr>
<tr><td><code>requestHash</code></td><td>PRCDHASH and associated hash algorithm</td></tr>
<tr><td><code>payeeHost</code></td><td>Host name as interpreted by the <b class="actor">Browser</b>.
Incuded for optional validation by the <b class="actor">Issuer</b>, aided by the <b class="actor">Aquirer</b></td></tr>
<tr><td><code>accountId</code></td><td><b class="actor">User</b> account number associated with the selected crdential</td></tr>
<tr><td><code>paymentMethod</code></td><td>Payment method associated with the selected credential.
Included for &quot;completeness&quot;</td></tr>
<tr><td><code>networkData</code></td><td><i>Optional</i>.  This element MUST be included if
specified in the <code>PaymentRequest</code> constructor
for the particular <code>paymentMethod</code>, otherwise it MUST NOT be defined</td></tr>
<tr><td><code>userAuthorizationMethod</code></td><td>Currently FINGERPRINT, FACERECOGNITION, and PIN are supported.
Included for <i>security and logging</i> purposes</td></tr>
<tr><td><code>platformData</code></td><td>Up-to-date information about the core <i>software</i> components.
<i>Device data</i> is assumed to be established during credential enrollment.
Included for security and logging purposes</td></tr>
<tr><td><code>timeStamp</code></td><td>ISO time stamp generated by the <b class="actor">Browser</b></td></tr>
</table>
<div>
  This object is subsequently referred to as Authorization Data (AD).
</div>

<div id="seq-4.4" class="step">4.4 Create Signed Authorization Data (SAD)</div>
<div class="para">
  Using the FIDO signature key associated with the selected
  payment credential, sign AD using the
  <a href="https://tools.ietf.org/html/draft-jordan-jws-ct-02"
      title="JWS/CT">JWS/CT<img src="images/xtl.svg" alt="link"></a> method.
  For the sample code this should result in the following object:
</div>
<pre class="box">
{
  "requestHash": {
    "algorithm": "S256",
    "value": "-5AfYJfNayqcxJs2nqkUm7EKKLS1oPumgWNWc1BCPuQ"
  },
  "payeeHost": "spaceshop.com",
  "accountId": "FR7630002111110020050014382",
  "paymentMethod": "https://europeanpaymentsinitiative.eu/fwp",
  "networkData": "additional stuff...",
  "userAuthorizationMethod": "FINGERPRINT",
  "platformData": {
    "operatingSystem": {
      "name": "Android",
      "version": "10"
    },
    "userAgent": {
      "name": "Chrome",
      "version": "95"
    }
  },
  "timeStamp": "2021-03-09T10:32:35+01:00",
  "signature": "eyJhbGciOiJFUzI1NiIsImp3ayI6eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6IjZCS3hwdHk4Y0ktZXhEekNraC1nb1U2ZFhxM01iY1kwY2QxTGFBeGlOclUiLCJ5IjoibUNiY3ZVem00NGozTHQyYjVCUHlRbG9ROTF0ZjJEMlYtZ3plVXhXYVVkZyJ9fQ..x5Cn16130rB1CBOo5h7rU_3Ln96Xc2aC1B3tkzmfPMaKTkf3LyDmUlT6IM_RRUiXGKBc0PkCnt0LnQG_-kYjcw"
}
</pre>
<div>
  This operation adds a single element (<code>signature</code>) to AD.
</div>
<div class="para">  This object is subsequently referred to as Signed Authorization Data (SAD).</div>
<div class="para">
  <span style="color:red">
    NOTE: The current FIDO authenticator API (CTAP2)
    <i>is not compatible with JWS</i>,
    which may require a slighly modified way dealing with the inner part of JWS/CT:
  </span>
  <a href="https://www.pcisecuritystandards.org"
     title="PCI Site">https://github.com/w3c/webauthn/issues/1581<img src="images/xtl.svg" alt="link"></a>.
</div>

<div class="para">
  To simplify backend processing, the public key associated with the FIDO key of
  the selected payment credential MUST be included in the JWS header.
  In the sample the following key was used:
</div>
<pre class="box">
{
  "kty": "EC",
  "crv": "P-256",
  "x": "6BKxpty8cI-exDzCkh-goU6dXq3MbcY0cd1LaAxiNrU",
  "y": "mCbcvUzm44j3Lt2b5BPyQloQ91tf2D2V-gzeUxWaUdg"
}
</pre>
<div id="seq-4.5" class="step">4.5 Create Encrypted Signed Authorization Data (ESAD)</div>
<div class="para">
  For privacy and security reasons, Signed Authorization Data (SAD) objects
  MUST be encrypted by a public key provided by the <b class="actor">Issuer</b>
  through the selected payment credential"s <code>encryptionKey</code> element.
  This specification mandates using JWE
  (<a href="https://tools.ietf.org/html/rfc7516"
      title="JWE">RFC7516<img src="images/xtl.svg" alt="link"></a>),
  in the compact serialization mode. The selection between
  RSA or ECDH encryption schemes is at the discretion of the <b class="actor">Issuer</b>.
  SAD objects MUST be JSON-serialized to UTF-8 before being encrypted.
  The resulting JWE string would look something like this
  (with line breaks for display purposes only):
</div>
<pre class="box">
eyJhbGciOiJSU0EtT0FFUCIsImVuYyI6IkEyNTZHQ00ifQ.OKOawDo13gRp2oja
HV7LFpZcgV7T6DVZKTyKOMTYUmKoTCVJRgckCL9kiMT03JGeipsEdY3mx_etLbb
WSrFr05kLzcSr4qKAq7YN7e9jwQRb23nfa6c9d-StnImGyFDbSv04uVuxIp5Zms
1gNxKKK2Da14B8S4rzVRltdYwam_lDp5XnZAYpQdb76FdIKLaVmqgfwX7XWRxv2
322i-vDxRfqNzo_tETKzpVLzfiwQyeyPGLBIO56YJ7eObdv0je8860ppamavo35
UgoRdbYaBcoh9QcfylQr66oc6vFWXRcZ_ZT2LawVCWTIy3brGPi6UklfCpIMfIj
f7iGdXKHzg.48V1_ALb6US04U3b.5eym8TW_c8SuK0ltJ3rpYIzOeDQz7TALvtu
6UG9oMo4vpzs9tX_EFShS8iB7j6jiSdiwkIr3ajwQzaBtQD_A.XFBoMYUZodetZ
dvTiFvSkQ
</pre>
<div>
  This object is subsequently referred to as Encrypted Signed Authorization Data (ESAD).
</div>
<div class="para">
  Note that the JWE header MUST include the <code>encryptionKey</code> as well.
</div>
<div class="para box comment">
  Note that due to the end-2-end encryption scheme, the domain 
constraints usually associated with FIDO, do not apply.
</div> 

<div id="seq-4.6" class="step">4.6 Assemble FWP Assertion</div>
<div class="para">
  Create a JSON object representing an <span class="msg">FWP Assertion</span>.
  For the sample code this should result in the following object:
</div>
<pre class="box">
{
  "encryptedAuthorization": <i>"ESAD"</i>,
  "paymentMethod": "https://europeanpaymentsinitiative.eu/fwp",
  "issuerId": "https://mybank.fr/payment"
}
</pre>
<div>Description:</div>
<table class="tftable">
<tr><th>Element</th><th>Comment</th></tr>
<tr><td><code>encryptedAuthorization</code></td><td>
  Encrypted Signed Authorization Data.
  Here shown as a placeholder only since
  an ESAD string can be quite long</td></tr>
<tr><td><code>paymentMethod</code></td><td>Payment method associated with the selected credential</td></tr>
<tr><td><code>issuerId</code></td><td>Issuer Id associated with the selected credential</td></tr>
</table>
<div>
  The <span class="msg">FWP Assertion</span> is made available
  to the <code>PaymentRequest</code> invocation code via the
<code>PaymentResponse.details</code> element.
</div>

<div class="step"><div id="seq-5" class="numbox">5</div>Send FWP Assertion</div>
<div>
  At this point the checkout Web code would normally
  send the completed <span class="msg">FWP Assertion</span> to the
  <b class="actor">Merchant</b> server through a FORM&nbsp;POST
or <code>fetch()</code> operation.
</div>
<div class="step"><div id="seq-6" class="numbox">6</div>Create AcquirerRequest Message</div>

<div>After receiving the <span class="msg">FWP Assertion</span>,
the <b class="actor">Merchant</b> would usually call an
<b class="actor">Acquirer</b> with a specifically crafted object (which
is out of scope for this specification).
The following hypothetical sample outlines such an object:</div>
<pre class="box">
{
  "paymentRequest": {
    "id": "7040566321",
    "payee": "Space Shop",
      "amount": {
      "currency": "EUR",
      "value": "435.00"
    }
  },
  "encryptedAuthorization": <i>"ESAD"</i>,
  "paymentMethod": "https://europeanpaymentsinitiative.eu/fwp",
  "networkData": "additional stuff...",
  "issuerId": "https://mybank.fr/payment"
  "receiveAccount": "123456789",
  "clientIp": "220.13.198.144",
  "timeStamp": "2021-03-09T10:32:36+01:00"
}
</pre>
<div>Description:</div>
<table class="tftable">
  <tr><th>Element</th><th>Comment</th></tr>
  <tr>
    <td><code>paymentRequest</code></td>
    <td>Copy of <a href="#seq-4.1">PRCD</a>, <i>recreated</i> by the <b class="actor">Merchant</b></td>
  </tr>
  <tr><td><code>encryptedAuthorization</code></td><td>Copy of the same element in the <a href="#seq-4.6">FWP Assertion</a></td></tr>
  <tr><td><code>paymentMethod</code></td><td>Copy of the same element in the <a href="#seq-4.6">FWP Assertion</a></td></tr>
  <tr>
    <td><code>networkData</code></td>
    <td>
      <i>Optional</i>.  See <a href="#seq-4.3">Authorization Data</a>
    </td>
  </tr>
  <tr><td><code>issuerId</code></td><td>Copy of the same element in the <a href="#seq-4.6">FWP Assertion</a></td></tr>
  <tr>
    <td><code>receiveAccount</code></td>
    <td>
      <b class="actor">Merchant</b> account to be credited
    </td>
  </tr>
  <tr>
    <td><code>clientIp</code></td>
    <td>
      Request IP address (in V4 or V6 format) of the <b class="actor">User</b> device.
      Included for <i>security and logging</i> purposes
    </td>
  </tr>
  <tr><td><code>timeStamp</code></td><td>ISO time stamp generated by the <b class="actor">Merchant</b></td></tr>
</table>
<div class="step">
  <div id="seq-7" class="numbox">7</div>Send AcquirerRequest Message
</div>
<div>
  At this point the <b class="actor">Merchant</b> sends the completed <kbd>AquirerRequest</kbd>
  object to the appropriate <b class="actor">Acquirer</b>.
</div>
<div class="para">Note that authentication of the <b class="actor">Merchant</b> is out of scope
for this specfication.</div>
<div class="comment box">
  Since FWP offers &quot;Payment System Neutrality&quot;,
  a <b class="actor">Merchant</b> may use different <b class="actor">Acquirer</b>
  service providers, depending on <code>paymentMethod</code>.
</div>
<div class="step">
  <div id="seq-8" class="numbox">8</div>Create IssuerRequest Message
</div>
  <div>After successfully having authenticated the <b class="actor">Merchant</b> request,
the <b class="actor">Acquirer</b> MUST perform a number ckecks including:</div>
<ul>
<li>
That <code>paymentRequest</code> is properly formatted and that
the <code>payee</code> attribute
matches the <b class="actor">Merchant</b> common name registered with the <b class="actor">Acquirer</b>.
</li>
<li>
That the <code>paymentMethod</code> is supported.
</li>
<li>
That the format of the <code>issuerId</code> matches <code>paymentMethod</code>.
</li>
<li>
  That the <code>receiveAccount</code> matches a <b class="actor">Merchant</b> account 
registered with the <b class="actor">Acquirer</b>.
</li>
<li>
  That the <code>timeStamp</code> is within &quot;reasonable limits&quot;.
</li>
<li>
That the rest of the expected parameters are available as well that there are no unknown elements.
</li>
</ul>
<div class="para">Any deviations MUST cause the request to be rejected.
Fault handling is out of scope for
this specification.</div>
<div class="para">The next step is creating a suitable IssuerRequest message.  
The following is an example of such an object:</div>
<pre class="box">
{
  "acquirerMessage": {
    "paymentRequest": {
      "id": "7040566321",
      "payee": "Space Shop",
        "amount": {
        "currency": "EUR",
        "value": "435.00"
      }
    },
    "encryptedAuthorization": <i>"ESAD"</i>,
    "paymentMethod": "https://europeanpaymentsinitiative.eu/fwp",
    "networkData": "additional stuff...",
    "issuerId": "https://mybank.fr/payment"
    "receiveAccount": "123456789",
    "clientIp": "220.13.198.144",
    "timeStamp": "2021-03-09T10:32:36+01:00"
  },
  "payeeHost": "spaceshop.com",
  "timeStamp": "2021-03-09T10:32:37+01:00"
}
</pre>

<div>Description:</div>
<table class="tftable">
  <tr><th>Element</th><th>Comment</th></tr>
  <tr>
    <td><code>aquirerRequest</code></td>
    <td>Copy of the message received from the <b class="actor">Merchant</b></td>
  </tr>
  <tr>
    <td><code>payeeHost</code></td>
    <td>
      The <b class="actor">Merchant</b> host name registered by the <b class="actor">Acquirer</b>
    </td>
  </tr>
  <tr><td><code>timeStamp</code></td><td>ISO time stamp generated by the <b class="actor">Acquirer</b></td></tr>
</table>
<div class="step">
  <div id="seq-9" class="numbox">9</div>Sending IssuerRequest Message
</div>
  <div>At this point the <b class="actor">Merchant</b></div>
  <div id="seq-10" class="numbox">10</div>Issuer IREQ Processing
  <div>
    At this point the <b class="actor">Issuer</b>
    The Issuer MUST now perform a number of steps to verify the correctness of the received AREQ. With respect to the User the following steps are the most significant:

    10.1 Decrypt the encryptedAuthorization object in AREQ using the Issuer specific (but shared) decryption key. Set result as AD.

    10.2 Retrieve the signature key declared in the JWS header of the AD signature element. Abort if unknown.

    10.3 Verify that the retrieved signature key is associated with the AD accountId element. Abort on failure.

    10.4 Validate the AD signature using the retrieved signature key. Abort on failure.

    10.5 Perform the same calculation as specified in 4.1 on the received paymentRequest object and compare the result with the AD requestHash. Abort on failure.

    10.6 Check that the AD timeStamp element is within limits. Tentative: CurrentTime - 600s &lt; timeStamp &lt; CurrentTime + 60s. Abort on failure.

    10.7 To cope with possible replays, check that the received AD has not already been utilized. Ideally, the Issuer should support idempotent operation to facilitate benign transaction retries.

    Available funds also needs to be validated but that is out of scope for this specification.
  </div>

  <div id="integration" class="header">
    Integration
  </div>
  <div>
    It is obvious that the integration of systems like FWP in payment networks
    is crucial for acceptance by the market.
  </div>
  <div class="para">
    For card based payments FWP implementations can build on the existing
    EMV foundation since essentially only the formats differ.
    Although the lack of a PAN (card number) in FWP may appear as a major obstacle,
    the <code class="reserved">issuerId</code> would in this case hold a &quot;neutered&quot; PAN where
    the BIN (Bank Identification Number) is set, while the rest are set to zeroes + Luhn check digit.
    E.g. VISA: 4972039000000004.  However, using <b class="actor">Issuer</b> URLs
    is also a viable alternative for card payments because the payment processors
    associated with &quot;regular&quot; EMV and FWP payments do probably not
    use the same end point.
  </div>
  <div class="para">
    For account-to-account payments there are currently no generally agreed upon standards
    for consumer payments, making it hard to come up with FWP implementation guidlines.
    Remapping existing card based systems and infrastructures seems though like a possible path.
  </div>
  <div class="para">
    Open Banking may also become a factor because there is work under way making non-OAuth2
    requests a part of Open Banking APIs.  There are good reasons for that since current Open Banking
    payment APIs presume that the <b class="actor">User</b> in some OOB way informs the
    <b class="actor">Merchant</b> who their <b class="actor">Issuer</b> is, which becomes
    quite impractical when the number of issuers grow.  In an Open Banking scenario powered by FWP,
    a Payment Initiation Service Provider (PISP) would effectively perform the same tasks as a
    traditional <b class="actor">Acquirer</b>, albeit regulated.  That is, there would unlikely
    be any <b class="actor">User</b> interactions with such a PISP.
  </div>
  <div id="extensions" class="header">
    Extensions
  </div>
  <div>
    The FWP core is loosely derived from a PoC system known as
    <a href="https://cyberphone.github.io/doc/saturn/"
       title="Saturn">Saturn<img src="images/xtl.svg" alt="link" /></a>.
    By building on this core, Saturn features like the following could potentially be added:
    <ul style="margin-bottom:0.3em">
      <li>
        Support for <i>non-direct payments</i>,
        including secure (<i>tokenized</i>) versions of Card-on-File.
      </li>
      <li>
        Support for <i>refunding</i> a <b class="actor">User</b>.
      </li>
      <li>
        Support for universal <i>digital receipts</i>.
      </li>
      <li>
        Support for <i>private messaging</i> and additional authentication information between the
        <b class="actor">Issuer</b> and <b class="actor">User</b>.
      </li>
    </ul>
    Not that some of the features above could impact the PaymentRequest API.
  </div>
  <div class="para">
    A radical change would be moving the FWP implementation down into the client platform layer.
    This would open FWP to other payment scenarios like point-of-sale (PoS) and person-to-person (P2P).
    It would also make it considerably easier for alternative browser vendors adopting the FWP system.
  </div>
  <div id="acknowledgements" class="header">
    Acknowledgements
  </div>
  <div>
    The FWP core was heavily influenced by an earlier Microsoft research project
    called <a href="https://en.wikipedia.org/wiki/Windows_CardSpace"
              title="CardSpace">Windows CardSpace<img src="images/xtl.svg" alt="link"></a>.
  </div>
  <div id="version" class="header">
    Version
  </div>
  <table class="tftable">
    <tr><th>Date</th><th>Version</th><th>Comment</th></tr>
    <tr><td>2020-03-10</td><td>0.1</td><td>Initial publishing</td></tr>
  </table>
  <div id="authors" class="header">
    Authors
  </div>
  <div>
    The FWP specification is currently authored by Anders Rundgren (<kbd>anders.rundgren.net@gmail.com</kbd>).<br />
  </div>
  <div class="header">
    Trademarks
  </div>
  <div id="trademarks">
    FIDO is a registered trademark of the FIDO alliance.<br />
    EMV is a registered trademark of EMVCo.<br />&nbsp;<br />
    This specification represents an <i>independent effort</i>, not associated with the FIDO alliance or EMVCo.
  </div>
</body></html>
