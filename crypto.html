<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="images/favicon.png" sizes="192x192">
<title>FIDO Web Pay - Crypto</title><style>
.header {font-size:1.6em;margin:1em 0 0.8em 0}
.subheader {font-size:1.2em;margin-top:1em;margin-bottom:0.6em}
.step {font-size:1.2em;margin-top:1.5em;margin-bottom:0.6em}
.para {margin-top: 0.8em}
.gutter {margin-top: 0.3em}
.msg {font-weight:500}
.formula {overflow-x:auto;padding:0.5em 0 0.5em 1em;white-space:nowrap}
  .staticbox {
    font-family: "Noto Mono",monospace;
    margin: 0.8em 0 1em 0;
    box-sizing: border-box;
    word-break: break-all;
    border-width: 1px;
    border-style: solid;
    border-color: grey;
    padding: 10pt;
    box-shadow: 0.2em 0.2em 0.2em #d0d0d0;
    background-color: #f8f8f8;
  }
.comment {padding:0.5em 1em;margin-top:1.5em;display:inline-block;background-color:#fafffa}
.box {box-shadow: 0.2em 0.2em 0.2em #d0d0d0;border-width:1px;border-style:solid;border-color:black}
.numbox {border-width:1pt;border-style:solid;border-color:black;border-radius:0.3em;display:inline-block;margin-right:0.6em;padding:0 3pt}
.tftable {border-collapse:collapse;box-shadow:0.2em 0.2em 0.2em #d0d0d0;margin:0.6em 0 1em 0}
.tftable td {background-color: #fffdf2;padding: 0.4em 0.5em;border-width: 1px;border-style: solid; border-color: black}
.tftable th {font-weight: normal;padding: 0.4em 0.5em;background-color: #f8f8f8;text-align: center;border-width: 1px;border-style: solid; border-color: black}
.json {word-break:break-all;background-color:#f8f8f8;padding:1em;border-width:1px;border-style:solid;border-color:#a9a9a9;box-shadow:0.3em 0.3em 0.3em #d0d0d0}
body {margin:1em;font-size:10pt;font-family:Roboto,sans-serif;background-color:white}
code {font-family:"Noto Mono",monospace;color:maroon}
kbd {font-family: "Noto Mono",monospace}
pre {font-family:"Noto Mono",monospace;margin: 0.8em 0 1em 0;padding:0.6em 1em;background-color: #f8f8f8}
ul,ol {margin: 0;padding-left:2em}
li {margin-top:0.3em}
a {color:#4366bf;text-decoration:none;font-weight:500;white-space:nowrap}
.toc {padding:0 0 0.3em 1em}
</style>
</head>
<body>
  <img style="max-width:30%" src="images/fwp.svg" alt="logo" title="FWP logotype"/>
  <img style="max-width:30%;position:absolute;right:1em;top:1em" src="images/ipr.svg" alt="IPR declaration" title="IPR declaration"/>
  <div style="text-align:center" class="header">FIDO Web Pay - Crypto</div>
  <div id="toc" class="header">Table of Contents</div>
  <div class='toc'><a href='#1'>1 Introduction</a></div><div class='toc'><a href='#2'>2 Relationship to Existing Standards</a></div><div class='toc'><a href='#3'>3 Terminology</a></div><div class='toc'><a href='#4'>4 User Authorization</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#4.1'>4.1 Create Authorization Data (AD)</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#4.2'>4.2 Create Signed Authorization Data (SAD)</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#4.3'>4.3 Signature Algorithms</a></div><div class='toc'><a href='#5'>5 Encrypted User Authorization (ESAD)</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#5.1'>5.1 Encryption Object</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#5.2'>5.2 Encryption Process</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#5.3'>5.3 Content Encryption Algorithms</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#5.4'>5.4 Key Algorithms</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#5.5'>5.5 Key Encryption Algorithms</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#5.6'>5.6 Key Derivation Function</a></div><div class='toc'><a href='#6'>6 User Authorization Decoding and Verification</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#6.1'>6.1 Decrypt Authorization (ESAD)</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#6.2'>6.2 Decode Signed Authorization Data (SAD)</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#6.3'>6.3 Validate Signature</a></div><div class='toc'><a href='#7'>7 Sample Keys</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#7.1'>7.1 Signature Key</a></div><div class='toc'>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#7.2'>7.2 Encryption Key</a></div><div class='toc'><a href='#documenthistory'>Document History</a></div><div class='toc'><a href='#authors'>Authors</a></div><div class='toc'><a href='#trademarks'>Trademarks</a></div>
  <div id='1' class='header'>1. Introduction</div>
  <div>
    This document describes the cryptographic constructs used in 
    <a href="index.html"
       title="FIDO Web Pay">FIDO Web Pay<img src="images/xtl.svg" alt="link"></a> (FWP) Assertions.
  </div>
  <div class="para">To make the descriptions more accessible,
  the samples in the core document are used for illustrating the different processing steps.
  The samples depend on the keys provided in the <a href='#7'>Sample Keys</a> section.
</div> 
<div id='2' class='header'>2. Relationship to Existing Standards</div>
  <div>
    Since the user authorization component of <a href='index.html#seq-4.5'>FWP Assertions<img src='images/xtl.svg' alt='link'></a> is based on CBOR
    [<a href="https://tools.ietf.org/html/rfc8949"
        title="RFC8949">RFC8949<img src="images/xtl.svg" alt="link"></a>],
    one might assume that the cryptography would be based on
    COSE [<a href="https://tools.ietf.org/html/rfc8152"
             title="RFC8152">RFC8152<img src="images/xtl.svg" alt="link"></a>].
    However, this is only partially true because FIDO signatures (<a href='https://www.w3.org/TR/webauthn-2/' title='Web Authentication'>Web&nbsp;Authentication<img src='images/xtl.svg' alt='link'></a>) are
    incompatible with COSE. In addition, FWP authorization signatures build on
    deterministic CBOR as outlined in RFC8949, section 4.2.1.
  </div>
 <div id='3' class='header'>3. Terminology</div>
  <div>
    Throughout this document CBOR primitives are expressed in
    CDDL [<a href="https://tools.ietf.org/html/rfc8610"
             title="RFC8610">RFC8610<img src="images/xtl.svg" alt="link"></a>]
    notation.
  </div>
  <div class="para">
    Items in <code>red</code> refer to elements associated with the selected <a href='index.html#credentialdatabase'>Payment Credential<img src='images/xtl.svg' alt='link'></a>.
  </div>
<div id='4' class='header'>4. User Authorization</div>
  <div>
    Unlike <a href='https://www.w3.org/TR/webauthn-2/' title='Web Authentication'>Web&nbsp;Authentication<img src='images/xtl.svg' alt='link'></a>, FWP builds on an <i>authorization</i> concept derived
    from EMV&reg;.  That is, user authorizations are created entirely locally in the FWP client.
    Compatible FIDO authenticators MUST therefore be &quot;client side&quot; only.
  </div>
  <div class="para">
    The following subsections describe the steps required
    for creating the user authorization component of <a href='index.html#seq-4.5'>FWP Assertions<img src='images/xtl.svg' alt='link'></a>.
  </div>
<div id='4.1' class='subheader'>4.1. Create Authorization Data (AD)</div>
  <div>Before requesting the user to authorize (&quot;sign&quot;),
    the FWP client creates data to related to the
    payment request (aka &quot;dynamic linking&quot;) like in the sample from the
    main document:
  </div>
  <div style='overflow-x:auto;padding-right:0.2em'>
    <div class="staticbox" style='min-width:50em'>
      {<br>&nbsp;&nbsp;1:&nbsp;&quot;1.0&quot;,<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;7040566321&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;435.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;EUR&quot;<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;3:&nbsp;&quot;spaceshop.com&quot;,<br>&nbsp;&nbsp;4:&nbsp;&quot;FR7630002111110020050014382&quot;,<br>&nbsp;&nbsp;5:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;6:&nbsp;&quot;0057162932&quot;,<br>&nbsp;&nbsp;7:&nbsp;&quot;additional&nbsp;stuff...&quot;,<br>&nbsp;&nbsp;8:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;Android&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;10.0&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;Chrome&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;103&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;9:&nbsp;&quot;2022-08-18T10:14:07+01:00&quot;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ authorization /</span><br>&nbsp;&nbsp;10:&nbsp;{<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ signatureAlgorithm = ES256 /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-7,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ publicKey /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ kty = EC /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;2,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ crv = P-256 /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;1,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ x /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h&#039;e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5&#039;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ y /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3:&nbsp;h&#039;9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8&#039;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>}
    </div>
   </div>
   <div>
    This object is referred to as <a href='index.html#seq-4.2'>Authorization Data (AD)<img src='images/xtl.svg' alt='link'></a>.
  </div>
   <div id="authorization" class="para">
     Since this section is about cryptographic constructs, only the data in the
     <code>authorization</code> <kbd>map</kbd> (label <kbd>10</kbd>) is
     elaborated on here.
   </div>
   <div class="para">
   Definition:
</div>
<div style='overflow-x:auto;padding-right:0.2em'>
  <table class="tftable">
  <tr><th>Name</th><th>Label</th><th>Type</th><th style="min-width:25em">Description</th></tr>
  <tr>
    <td><code>signatureAlgorithm</code></td>
    <td style='text-align:center'><kbd>1</kbd></td>
    <td><kbd>int</kbd></td>
    <td>
      FIDO <code>signatureAlgorithm</code> associated with the selected <a href='index.html#credentialdatabase'>Payment Credential<img src='images/xtl.svg' alt='link'></a>.
      The value to use is the &quot;Identifier&quot; specified in the <a href='#4.3'>Signature Algorithms</a> table.
    </td>
  </tr>
  <tr>
    <td><code>publicKey</code></td>
    <td style='text-align:center'><kbd>2</kbd></td>
    <td><kbd>map</kbd></td>
    <td>
      FIDO <code>publicKey</code> descriptor associated with the selected <a href='index.html#credentialdatabase'>Payment Credential<img src='images/xtl.svg' alt='link'></a>.
      The key descriptor MUST only contain the core public key data.
      This item MUST be COSE compliant as well as be compatible with the
      <code>signatureAlgorithm</code>.
    </td>
  </tr>
  <tr>
    <td><code>authenticatorData</code></td>
    <td style='text-align:center'><kbd>3</kbd></td>
    <td><kbd>bstr</kbd></td>
    <td>
      FIDO assertion data element.
      See also <a href='https://www.w3.org/TR/webauthn-2/' title='Web Authentication'>Web&nbsp;Authentication<img src='images/xtl.svg' alt='link'></a>.
    </td>
  </tr>
  <tr>
    <td><code>signature</code></td>
    <td style='text-align:center'><kbd>4</kbd></td>
    <td><kbd>bstr</kbd></td>
    <td>
      FIDO assertion signature.
      See also <a href='https://www.w3.org/TR/webauthn-2/' title='Web Authentication'>Web&nbsp;Authentication<img src='images/xtl.svg' alt='link'></a>.
    </td>
  </tr>
  </table>
  </div>
   <div>
As can be seen in the listing, the <code>signatureAlgorithm</code> and 
<code>publicKey</code> elements are already featured in the <code>authorization</code> <kbd>map</kbd>.
This is because they are static and can thus be included in the data
to be signed, potentially making the signature scheme more resistant to tampering.
</div>
   <div class="para">
 The sample AD should read as follows
     when expressed in hexadecimal encoding:
   </div>
     <div style='overflow-x:auto;padding-right:0.2em'>
      <div class="staticbox">
      aa0163312e3002a4016a53706163652053686f70026a3730343035363633323103663433352e30300463455552036d737061636573686f702e636f6d04781b465237363330303032313131313130303230303530303134333832057468747470733a2f2f62616e6b6e6574322e6f7267066a3030353731363239333207736164646974696f6e616c2073747566662e2e2e08a201a20367416e64726f6964046431302e3002a203664368726f6d650463313033097819323032322d30382d31385431303a31343a30372b30313a30300aa2012602a401022001215820e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b52258209826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8
      </div>
    </div>
<div id='4.2' class='subheader'>4.2. Create Signed Authorization Data (SAD)</div>
     <div>
       Using the result of the previous step (but
       using binary encoding), as the sole data input to the
       FIDO signature process,
       the user should at this stage be asked to authorize a payment request
       using the key (authenticator)
       pointed out by the <code>credentialId</code> of the selected <a href='index.html#credentialdatabase'>Payment Credential<img src='images/xtl.svg' alt='link'></a>.
     </div>

   <div class="para">
    For a detailed description of how FIDO signatures are created,
    turn to <a href='https://www.w3.org/TR/webauthn-2/' title='Web Authentication'>Web&nbsp;Authentication<img src='images/xtl.svg' alt='link'></a>.  Note that AD is signed after <i>hashing</i>, making
    <code>clientDataHash</code> the actual data to be signed:
</div>
    <div style='overflow-x:auto;padding:0.5em 0.2em 0 0'>
<img src='https://www.w3.org/TR/webauthn-2/images/fido-signature-formats-figure2.svg' alt='signature'>
    </div>
   <div>
    After adding the asserted FIDO <code>authenticatorData</code> and
    <code>signature</code> elements to the <a href="#authorization">authorization</a>
   <kbd>map</kbd> of AD, the resulting sample should read as follows:</div>
    <div style='overflow-x:auto;padding-right:0.2em'>
      <div class="staticbox" style='min-width:50em'>
      {<br>&nbsp;&nbsp;1:&nbsp;&quot;1.0&quot;,<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;7040566321&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;435.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;EUR&quot;<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;3:&nbsp;&quot;spaceshop.com&quot;,<br>&nbsp;&nbsp;4:&nbsp;&quot;FR7630002111110020050014382&quot;,<br>&nbsp;&nbsp;5:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;6:&nbsp;&quot;0057162932&quot;,<br>&nbsp;&nbsp;7:&nbsp;&quot;additional&nbsp;stuff...&quot;,<br>&nbsp;&nbsp;8:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;Android&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;10.0&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;Chrome&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;103&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;9:&nbsp;&quot;2022-08-18T10:14:07+01:00&quot;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ authorization /</span><br>&nbsp;&nbsp;10:&nbsp;{<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ signatureAlgorithm = ES256 /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-7,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ publicKey /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ kty = EC /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;2,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ crv = P-256 /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;1,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ x /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h&#039;e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5&#039;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ y /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3:&nbsp;h&#039;9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8&#039;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ authenticatorData /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;h&#039;412e175a0f0bdc06dabf0b1db79b97541c08dbacee7e31c97a553588ee922ea70500000017&#039;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ signature /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;h&#039;304402202164244e30bbfa9c886e2ee4b66e4475c43614df7cc9687904829127990d7b7802200b286bb9708e7e5716cf33c5007f7cd166359e88b8d77c5f3fb035c05b084288&#039;<br>&nbsp;&nbsp;}<br>}
      </div>
    </div>
<div>This object is subsequently referred to as Signed Authorization Data (SAD).</div>
<div class="para">
    The sample SAD object should read as follows if encoded in hexadecimal:
  </div>
  <div style='overflow-x:auto;padding-right:0.2em'>
    <div class="staticbox">
    aa0163312e3002a4016a53706163652053686f70026a3730343035363633323103663433352e30300463455552036d737061636573686f702e636f6d04781b465237363330303032313131313130303230303530303134333832057468747470733a2f2f62616e6b6e6574322e6f7267066a3030353731363239333207736164646974696f6e616c2073747566662e2e2e08a201a20367416e64726f6964046431302e3002a203664368726f6d650463313033097819323032322d30382d31385431303a31343a30372b30313a30300aa4012602a401022001215820e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b52258209826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8035825412e175a0f0bdc06dabf0b1db79b97541c08dbacee7e31c97a553588ee922ea70500000017045846304402202164244e30bbfa9c886e2ee4b66e4475c43614df7cc9687904829127990d7b7802200b286bb9708e7e5716cf33c5007f7cd166359e88b8d77c5f3fb035c05b084288
    </div>
  </div>
  <div>
    After the Signed Authorization Data (SAD) has been created,
    it MUST be encrypted as described in <a href='#5'>Encrypted User Authorization (ESAD)</a>.
  </div>

<div id='4.3' class='subheader'>4.3. Signature Algorithms</div>
<div class="para">FIDO currently supports the following COSE signature algorithms:</div>
<div style='overflow-x:auto;padding-right:0.2em'>
  <table class="tftable">
    <tr><th>Name</th><th>Identifier</th><th>Notes</th></tr>
    <tr>
      <td style='white-space:nowrap'><kbd>ES256</kbd></td>
      <td style='text-align:center'><kbd>-7</kbd></td>
      <td>ECDSA signatures differs in encoding from COSE.
      See <a href='https://www.w3.org/TR/webauthn-2/' title='Web Authentication'>Web&nbsp;Authentication<img src='images/xtl.svg' alt='link'></a>.</td>
    </tr>
    <tr>
      <td style='white-space:nowrap'><kbd>ED25519</kbd></td>
      <td style='text-align:center'><kbd>-8</kbd></td>
      <td>This identifier is strictly put not COSE compliant.</td>
    </tr>
    <tr>
      <td style='white-space:nowrap'><kbd>RS256</kbd></td>
      <td style='text-align:center'><kbd>-257</kbd></td>
     <td></td>
    </tr>
  </table>
</div>

<div id='5' class='header'>5. Encrypted User Authorization (ESAD)</div>
<div id="esad">
  For privacy and security reasons the user authorization component of <a href='index.html#seq-4.5'>FWP Assertions<img src='images/xtl.svg' alt='link'></a>
  MUST be encrypted.
</div>
<div class="para">The listing below shows how the sample <a href='#4.2'>SAD</a> object could be encrypted:</div>
<div style='overflow-x:auto;padding-right:0.2em'>
  <div class="staticbox" style='min-width:50em'>
  {<br><div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ algorithm = A256GCM /</span><br>&nbsp;&nbsp;1:&nbsp;3,<br><div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ keyEncryption /</span><br>&nbsp;&nbsp;2:&nbsp;{<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ algorithm = ECDH-ES+A256KW /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-31,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ keyId /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;x25519:2022:1&quot;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ ephemeralKey /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;7:&nbsp;{<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ kty = OKP /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;1,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ crv = X25519 /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;4,<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ x /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h&#039;60cce45a5b878d5d3277ed66a564a673c704d491fac2b52d7a31a9f034ff6d15&#039;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br><div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ cipherText /</span><br>&nbsp;&nbsp;&nbsp;&nbsp;10:&nbsp;h&#039;f2e753aa020fbd27f726496f1c661d26a23c6ae3d06ccec977606862c554b02226b83e038b285c9f&#039;<br>&nbsp;&nbsp;},<br><div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ tag /</span><br>&nbsp;&nbsp;8:&nbsp;h&#039;292c4baf5efd357c7dffeeba2851fc7e&#039;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ iv /</span><br>&nbsp;&nbsp;9:&nbsp;h&#039;cf7bbe8c0cef6b95fcd18ebd&#039;,<br><div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ cipherText /</span><br>&nbsp;&nbsp;10:&nbsp;h&#039;ed573a67405e553b8f25583ce67f19a00969bf9e7c222402d265cacb2687135219ece15d8de3ede8dba574a3294d4f469ac9ac2ff8f85f2041be2e5d8b2386fb9cb65b81fad96ef7ebb4c9e29fd00adf5f9b505593b274fb265072c76cc8f18f95bf4131a8d22de848268de9192a4f94aa90ab2f478ae5b18a4adecf20dc088b021d0741d812f5f77c677d39fbbf2314ed79d4e3389abd01fa8eb2e1ebb4a1ed46a2ac08ba0cfa9336f8d029fb1cde6ca5a65796492635ce8cbb0586103271de1f1f74d20fc57ed82764b19c56d323cfaffcd5a5010233f520fb452c94df621e9bb6caee1842a05fc844ac5c780669357c4fc06beae0290637dc212506b67a1e2def83ad975ffd735bdc533eca7fdc42981392b7f2f3039e0d64c4d6428e9b9cfeac78e86727cf25726fcae63ce9f98cedff7eba3e14a1d82bb7a5713f1ebaa9d39b171b93949b8950422468431761516097d8c03579eed5ca57aa377d6316f2695fba20cd8b78c21f611ef9718391cb604ac2ea7eb1d8e189213a8fa693ef74187a7070855091af1b1574d973086fbe&#039;<br>}
  </div>
</div>
<div>The resulting object is referred to as Encrypted Signed Authorization Data (ESAD).</div>
<div class="para">
  The sample ESAD object should read as follows if encoded in hexadecimal:
</div>
<div style='overflow-x:auto;padding-right:0.2em'>
<div class="staticbox">
a5010302a401381e036d7832353531393a323032323a3107a30101200421582060cce45a5b878d5d3277ed66a564a673c704d491fac2b52d7a31a9f034ff6d150a5828f2e753aa020fbd27f726496f1c661d26a23c6ae3d06ccec977606862c554b02226b83e038b285c9f0850292c4baf5efd357c7dffeeba2851fc7e094ccf7bbe8c0cef6b95fcd18ebd0a590190ed573a67405e553b8f25583ce67f19a00969bf9e7c222402d265cacb2687135219ece15d8de3ede8dba574a3294d4f469ac9ac2ff8f85f2041be2e5d8b2386fb9cb65b81fad96ef7ebb4c9e29fd00adf5f9b505593b274fb265072c76cc8f18f95bf4131a8d22de848268de9192a4f94aa90ab2f478ae5b18a4adecf20dc088b021d0741d812f5f77c677d39fbbf2314ed79d4e3389abd01fa8eb2e1ebb4a1ed46a2ac08ba0cfa9336f8d029fb1cde6ca5a65796492635ce8cbb0586103271de1f1f74d20fc57ed82764b19c56d323cfaffcd5a5010233f520fb452c94df621e9bb6caee1842a05fc844ac5c780669357c4fc06beae0290637dc212506b67a1e2def83ad975ffd735bdc533eca7fdc42981392b7f2f3039e0d64c4d6428e9b9cfeac78e86727cf25726fcae63ce9f98cedff7eba3e14a1d82bb7a5713f1ebaa9d39b171b93949b8950422468431761516097d8c03579eed5ca57aa377d6316f2695fba20cd8b78c21f611ef9718391cb604ac2ea7eb1d8e189213a8fa693ef74187a7070855091af1b1574d973086fbe
</div>
</div>
<div class="para">The following subsections describe the encryption scheme in detail.</div>
<div id='5.1' class='subheader'>5.1. Encryption Object</div>
<div class="para">
  The encryption scheme is based on an ECDH profile derived from
<a href="https://cyberphone.github.io/javaapi/org/webpki/cbor/package-summary.html#cef">
CBOR Encryption Format (CEF)<img src="images/xtl.svg" alt="link">
</a>.  ESAD objects are packaged as follows:
</div>
    <div style="overflow-x:auto;padding:8pt 0">
      <svg style='display:block;width:27em;padding:1em' class='box' viewBox='0 0 1065 680' xmlns='http://www.w3.org/2000/svg'>
<title>FWP Encryption Layout</title>
<!-- Anders Rundgren 2021 -->
<g stroke='#4366bf' stroke-width='3' fill='none'>
<rect x='20' y='180' width='460' height='80' rx='8'/>
<rect x='20' y='280' width='460' height='80' rx='8'/>
<rect x='20' y='380' width='460' height='80' rx='8'/>
<rect x='20' y='480' width='460' height='80' rx='8'/>
<rect x='20' y='580' width='460' height='80' rx='8'/>
<rect x='605' y='180' width='440' height='80' rx='8'/>
<rect x='605' y='280' width='440' height='80' stroke-dasharray='8' rx='8'/>
<rect x='605' y='380' width='440' height='80' stroke-dasharray='8' rx='8'/>
<rect x='605' y='480' width='440' height='80' rx='8'/>
<rect x='605' y='580' width='440' height='80' stroke-dasharray='8' rx='8'/>
</g>
<g font-size='40' font-family='Roboto,sans-serif'>
<text x='250' y='70' font-size='50' text-anchor='middle'>Main Map</text>
<text x='250' y='120' text-anchor='middle'>(Content Encryption)</text>
<text x='825' y='70' font-size='50' text-anchor='middle'>Sub Map</text>
<text x='825' y='120' text-anchor='middle'>(Key Encryption)</text>
</g>
<g font-size='40' font-family='Noto Mono,monospace' fill='maroon'>
<text x='44' y='234'>algorithm<tspan fill='black'> (1)</tspan></text>
<text x='44' y='334'>keyEncryption<tspan fill='black'> (2)</tspan></text>
<text x='44' y='434'>tag<tspan fill='black'> (8)</tspan></text>
<text x='44' y='534'>iv<tspan fill='black'> (9)</tspan></text>
<text x='44' y='634'>cipherText<tspan fill='black'> (10)</tspan></text>
<text x='629' y='234'>algorithm<tspan fill='black'> (1)</tspan></text>
<text x='629' y='334'>keyId<tspan fill='black'> (3)</tspan></text>
<text x='629' y='434'>publicKey<tspan fill='black'> (4)</tspan></text>
<text x='629' y='534'>ephemeralKey<tspan fill='black'> (7)</tspan></text>
<text x='629' y='634'>cipherText<tspan fill='black'> (10)</tspan></text>
</g>
<path fill='none' stroke='#4366bf' stroke-width='3' stroke-linecap='round' d='M500,180  m 85,0 c -33,0 -35,68 -35,68 0,30 -18,68 -48,72 30,8 48,35 48,80 v 186 c 0,0 0,74 36,74'/>
</svg>

    </div>
<div>Numbers in parentheses represent the CBOR <kbd>map</kbd> key
(label) associated with the symbolic name.
The elements in the dashed boxes are <i>optional</i>, depending on
key encryption algorithm and encryption key reference method.</div>
<div id="mainmap" class="para">Main map definition:</div>

<div style='overflow-x:auto;padding-right:0.2em'>
  <table class="tftable">
  <tr><th>Name</th><th>Label</th><th>Type</th><th style="min-width:25em">Description</th></tr>
  <tr>
    <td><code>algorithm</code></td>
    <td style='text-align:center'><kbd>1</kbd></td>
    <td><kbd>int</kbd></td>
    <td>
      Symmetric key algorithm used for encrypting the actual content.
      The value to use is the &quot;Identifier&quot; specified in the
     <a href='#5.3'>Content Encryption Algorithms</a> table.
    </td>
  </tr>
  <tr>
    <td><code>keyEncryption</code></td>
    <td style='text-align:center'><kbd>2</kbd></td>
    <td><kbd>map</kbd></td>
    <td>
      Holds the <a href="#submap">Sub map</a>.
    </td>
  </tr>
  <tr>
    <td><code>tag</code></td>
    <td style='text-align:center'><kbd>8</kbd></td>
    <td><kbd>bstr</kbd></td>
    <td>
      Algorithm specific authentication data.
    </td>
  </tr>
  <tr>
    <td><code>iv</code></td>
    <td style='text-align:center'><kbd>9</kbd></td>
    <td><kbd>bstr</kbd></td>
    <td>
      Algorithm specific initialization vector.
    </td>
  </tr>
  <tr>
    <td><code>cipherText</code></td>
    <td style='text-align:center'><kbd>10</kbd></td>
    <td><kbd>bstr</kbd></td>
    <td>
      Encrypted content.
    </td>
  </tr>
  </table>
</div>

<div id="submap" class="para">Sub map definition:</div>

<div style='overflow-x:auto;padding-right:0.2em'>
  <table class="tftable">
    <tr><th>Name</th><th>Label</th><th>Type</th><th style="min-width:25em">Description</th></tr>
    <tr>
      <td><code>algorithm</code></td>
      <td style='text-align:center'><kbd>1</kbd></td>
      <td><kbd>int</kbd></td>
      <td>
        Key encryption algorithm.
        The value to use is the &quot;Identifier&quot; specified in the
        <a href='#5.5'>Key Encryption Algorithms</a> table.
      </td>
    </tr>
    <tr>
      <td><code>keyId</code></td>
      <td style='text-align:center'><kbd>3</kbd></td>
      <td><i>&quot;Any&quot;</i></td>
      <td>
        <i>Optional</i>: To facilitate a streamlined decryption process,
        the encryption object MUST include a reference to the
        encryption key.  This reference is either provided through a <code>keyId</code>
        or through the <code>publicKey</code> itself. That is, both elements MUST NOT
        be present in an FWP compliant encryption object.
        <div class="para">
          Note that the this specification does not define any specific <code>keyId</code> syntax.
          The sample uses a <kbd>tstr</kbd> but it could equally well be 
          a hash of the <code>publicKey</code> featured in a <kbd>bstr</kbd>.
        </div>
      </td>
    </tr>
    <tr>
      <td><code>publicKey</code></td>
      <td style='text-align:center'><kbd>4</kbd></td>
      <td><kbd>map</kbd></td>
      <td>
        <i>Optional</i>: Public key in COSE format.  See <code>keyId</code>.
        <div class="para">
          Note that a <code>publicKey</code> element MUST only contain the
          core public key data.
        </div>
      </td>
    </tr>
    <tr>
      <td><code>ephemeralKey</code></td>
      <td style='text-align:center'><kbd>7</kbd></td>
      <td><kbd>map</kbd></td>
      <td>
        Ephemeral public key in COSE format.
        <div class="para">
          Note that a <code>publicKey</code> element MUST only contain the
          core public key data.
        </div>
      </td>
    </tr>
    <tr>
      <td><code>cipherText</code></td>
      <td style='text-align:center'><kbd>10</kbd></td>
      <td><kbd>bstr</kbd></td>
      <td>
        <i>Optional</i>: Encrypted key for key-wrapping ECDH algorithms.
      </td>
    </tr>
  </table>
</div>

<div id='5.2' class='subheader'>5.2. Encryption Process</div>
To encrypt a <a href='#4.2'>SAD</a> object, the following steps MUST be performed:
<ol>
  <li>
    Retrieve the <code>keyEncryptionAlgorithm</code>,
    <code>contentEncryptionAlgorithm</code>,
    and <code>encryptionKey</code> elements of the selected <a href='index.html#credentialdatabase'>Payment Credential<img src='images/xtl.svg' alt='link'></a>.
    The compatibility of these elements with respect to this specification,
    as well as with the client implementation, is assumed
    to have been verified during credential enrollment.
  </li>
  <li>Create an empty CBOR <a href="#submap">Sub map</a> object.</li>
  <li>
    Copy the <code>keyEncryptionAlgorithm</code> to the <code>algorithm</code> label.
  </li>
  <li>
    If the <code>encryptionKeyId</code> of the selected <a href='index.html#credentialdatabase'>Payment Credential<img src='images/xtl.svg' alt='link'></a>
    is defined, copy the value to the <code>keyId</code> label,
    else copy the <code>encryptionKey</code> to the <code>publicKey</code> label.
</li>
<li>Creating a key for encrypting the content (SAD) requires the following steps:
<ul>
<li>
Generate a key pair compatible with the <code>encryptionKey</code>.
</li>
<li>Copy the public key of the generated key pair to the <code>ephemeralKey</code> label.</li>
<li>
  Perform the core ECDH operation (key agreement) including the <a href='#5.6'>KDF</a>,
  using the private key of the generated key pair and
  the <code>encryptionKey</code>.
  Note that the requested length of the shared secret generated by the KDF,
  is defined by the <code>keyEncryptionAlgorithm</code>. See <a href='#5.5'>Key Encryption Algorithms</a>.
</li>
<li>
  For the <kbd>ECDH-ES</kbd> (direct mode) <code>keyEncryptionAlgorithm</code>,
  set a varible <kbd>contentEncryptionKey</kbd> equal
  to the result of the ECDH operation.  For the other (key wrapping)
  ECDH variants, perform the following steps:
  <ul>
    <li>Define a <kbd>contentEncryptionKey</kbd> variable.</li>
    <li>Assign a random number to the <kbd>contentEncryptionKey</kbd>.</li>
    <li>
      Encrypt the <kbd>contentEncryptionKey</kbd> with the key wrapping method
      associated with the ECDH algorithm using
      the previously generated shared secret as encryption key.
    </li>
    <li>Copy the result of the previous operation to the <code>cipherText</code> label.</li>
  </ul>
  <div class="para" style="padding-bottom:0.5em">
    Note that the length of the <kbd>contentEncryptionKey</kbd> is defined by the
    <code>contentEncryptionAlgorithm</code>. See <a href='#5.3'>Content Encryption Algorithms</a>.
  </div>
</li>
</ul>
</li>
<li>Create an empty CBOR <a href="#mainmap">Main map</a> object.</li>
<li>
  Copy the <code>contentEncryptionAlgorithm</code>
  to the <code>algorithm</code> label.
</li>
<li>
  Copy the previously created CBOR <a href="#submap">Sub map</a> object to
  the <code>keyEncryption</code> label.
</li>
<li>Serialize the current <a href="#mainmap">Main map</a> object and assign the result
to an AAD (Additional Authenticated Data) variable.</li>
<li>
  Generate an IV (Initialization Vector) compliant with the
  <code>contentEncryptionAlgorithm</code>. See <a href='#5.3'>Content Encryption Algorithms</a>.
</li>
<li>Encrypt the SAD object as follows
<div class="formula">
<kbd>
cipherText, tag = encrypt(<code>contentEncryptionAlgorithm</code>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contentEncryptionKey,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SAD,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AAD,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IV)
</kbd>
</div>
    here using an hypothetical encryption method returning both
    the resulting <kbd>cipherText</kbd> and a <kbd>tag</kbd> value.
</li>
<li>Copy the <kbd>cipherText</kbd>, <kbd>tag</kbd>, and <kbd>IV</kbd> values to the
<code>cipherText</code>, <code>tag</code>, and <code>iv</code> labels
respectively.
</ol>
<div class="para">The resulting CBOR <a href="#mainmap">Main map</a>
object represents an <a href='#5'>ESAD</a> object according to this specification.</div>
<div id='5.3' class='subheader'>5.3. Content Encryption Algorithms</div>
<div>Compliant FWP
implementations MUST as a minimum support the following
COSE content encryption algorithms:</div>

<div style='overflow-x:auto;padding-right:0.2em'>
  <table class="tftable">
    <tr><th>Name</th><th>Identifier</th><th>Key</th><th>Tag</th><th>IV</th></tr>
    <tr>
      <td style='text-align:center'><kbd>A128GCM</kbd></td>
      <td style='text-align:center'><kbd>1</kbd></td>
      <td style='text-align:center'><kbd>16</kbd></td>
      <td style='text-align:center'><kbd>16</kbd></td>
      <td style='text-align:center'><kbd>12</kbd></td>
    </tr>
    <tr>
      <td style='text-align:center'><kbd>A192GCM</kbd></td>
      <td style='text-align:center'><kbd>2</kbd></td>
      <td style='text-align:center'><kbd>24</kbd></td>
      <td style='text-align:center'><kbd>16</kbd></td>
      <td style='text-align:center'><kbd>12</kbd></td>
    </tr>
    <tr>
      <td style='text-align:center'><kbd>A256GCM</kbd></td>
      <td style='text-align:center'><kbd>3</kbd></td>
      <td style='text-align:center'><kbd>32</kbd></td>
      <td style='text-align:center'><kbd>16</kbd></td>
      <td style='text-align:center'><kbd>12</kbd></td>
    </tr>
  </table>
</div>
<div>The length of the &quot;Key&quot;, &quot;Tag&quot;, and &quot;IV&quot;
elements are in bytes.</div>
<div id='5.4' class='subheader'>5.4. Key Algorithms</div>
<div>
  Compliant FWP implementations MUST as a
  minimum support <kbd>P-256</kbd> and <kbd>X25519</kbd> keys.
</div>

<div id='5.5' class='subheader'>5.5. Key Encryption Algorithms</div>
<div>Compliant FWP
implementations MUST as a minimum support the following
COSE key encryption algorithms:</div>
<div style='overflow-x:auto;padding-right:0.2em'>
  <table class="tftable">
    <tr><th>Name</th><th>Identifier</th><th>Derived&nbsp;Key</th></tr>
    <tr>
      <td style='white-space:nowrap'><kbd>ECDH-ES</kbd></td>
      <td style='text-align:center'><kbd>-25</kbd></td>
      <td>Defined by the content encryption algorithm.  See <a href='#5.3'>Content Encryption Algorithms</a>.</td>
    </tr>
    <tr>
      <td style='white-space:nowrap'><kbd>ECDH-ES+A128KW</kbd></td>
      <td style='text-align:center'><kbd>-29</kbd></td>
      <td style='text-align:center'><kbd>16</kbd></td>
    </tr>
    <tr>
      <td style='white-space:nowrap'><kbd>ECDH-ES+A192KW</kbd></td>
      <td style='text-align:center'><kbd>-30</kbd></td>
      <td style='text-align:center'><kbd>24</kbd></td>
    </tr>
    <tr>
      <td style='white-space:nowrap'><kbd>ECDH-ES+A256KW</kbd></td>
      <td style='text-align:center'><kbd>-31</kbd></td>
      <td style='text-align:center'><kbd>32</kbd></td>
    </tr>
  </table>
</div>
<div>
  The length of the &quot;Derived&nbsp;Key&quot; element is in bytes.
</div>

<div id='5.6' class='subheader'>5.6. Key Derivation Function</div>

<div>
  Note that the ECDH algorithms MUST use a Key Derivation Function (KDF) according to HKDF
  [<a href="https://tools.ietf.org/html/rfc5869"
      title="RFC5869">RFC5869<img src="images/xtl.svg" alt="link"></a>],
  profiled as follows:
</div>
<ul>
  <li><kbd>hmac</kbd>: The HKDF implementation MUST use HMAC with SHA256</li>
  <li><kbd>salt</kbd>: N/A. The default extract mode handling MUST be implemented.</li>
  <li><kbd>info</kbd>: This parameter MUST consist of the actual COSE key
encryption algorithm, expressed as a 32-bit (4 byte) signed big-endian integer.</li>
</ul>
<div id='6' class='header'>6. User Authorization Decoding and Verification</div>
<div>
  The following sections describe the steps needed for decoding
  the user authorization part (ESAD) of <a href='index.html#seq-4.5'>FWP Assertions<img src='images/xtl.svg' alt='link'></a>, as well as
  verifying that it is technically correct from a <i>cryptographic</i> point of view.
  As outlined in the core document, several other checks MUST also be performed
  before an associated payment request can be considered as trusted.
</div>
<div class="comment box">
  Missing, erroneous, or extraneous data MUST cause the verification
  process to terminate with an appropriate error indication.
</div>
<div id='6.1' class='subheader'>6.1. Decrypt Authorization (ESAD)</div>
<div>Decode the <a href='#5'>ESAD</a> binary using a suitable CBOR parser.</div>
<div class="para">
Perform the following steps to decrypt the ESAD object:
</div>
<ol>
  <li>
    Retrieve the private encryption key associated with the <code>encryptionKeyId</code> or
    the <code>publicKey</code> in the <a href="#submap">Sub map</a>, depending on
    which of the elements that are defined (which in most cases is known in advance
    since the issuer and relying party usually is the same entity).
  </li>
<li>
Fetch the ECDH algorithm to use from the <code>algorithm</code> element in the <a href="#submap">Sub map</a>.
</li>
  <li>
  Perform an ECDH key agreement operation including <a href='#5.6'>KDF</a> with the retrieved private key
  and the <code>ephemeralKey</code> element in the <a href="#submap">Sub map</a>. 
</li>
<li>
For key wrapping ECDH algorithms, use the result of the ECDH operation
to unwrap a <kbd>contentEncryptionKey</kbd> (specified by
the <code>cipherText</code> element in the <a href="#submap">Sub map</a>), while <kbd>ECDH-ES</kbd>
returns the <kbd>contentEncryptionKey</kbd> directly.  See <a href='#5.5'>Key Encryption Algorithms</a>.
</li>
<li>
  Fetch the <kbd>contentEncryptionAlgorithm</kbd> specified by the <code>algorithm</code>
  element in the <a href="#mainmap">Main map</a>.  See <a href='#5.3'>Content Encryption Algorithms</a>.
</li>
<li>Fetch and remove the <code>tag</code>, <code>iv</code>, and <code>cipherText</code>
elements in the <a href="#mainmap">Main map</a>.</li>
<li>Serialize the remaining CBOR object and assign the result to an
<kbd>AAD</kbd> (Additional Authenticated Data) variable.</li>
<li>
  Decrypt the ESAD object as follows
  <div class="formula">
    <kbd>
      plainText = decrypt(contentEncryptionAlgorithm,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contentEncryptionKey,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AAD,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>iv</code>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>tag</code>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>cipherText</code>)
    </kbd>
  </div>
  here using an hypothetical decryption method.
</li>
</ol>
<div class="para">If all steps succeed, the resulting plain text
is assumed to be a <a href='#4.2'>SAD</a> object.</div>
<div id='6.2' class='subheader'>6.2. Decode Signed Authorization Data (SAD)</div>
<div>Decode the <a href='#4.2'>SAD</a> binary using a suitable CBOR parser.</div>
<div class="para">Fetch and remove the FIDO elements <code>authenticatorData</code>
and <code>signature</code> from the decoded object
which now effectively is an <a href='#4.1'>AD</a> object.
</div>
<div id='6.3' class='subheader'>6.3. Validate Signature</div>
<div>
The signature is validated by applying the elements received in the 
<a href="#authorization">authorization</a> <kbd>map</kbd> to
a suitable signature validation API like:
</div>
<div class="formula">
<kbd>
<span style="color:grey">// Hypothetical signature validation method</span><br>
validate(<code>signatureAlgorithm</code>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>publicKey</code>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:grey">// Signed data</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>authenticatorData</code> || SHA256(<a href='#4.1'>AD</a>),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>signature</code>)
</kbd>
</div>
<div class="comment box">
Although the FIDO signature scheme is unique, signatures can be validated by
any cryptographic API supporting the signature algorithm in question.
</div>
<div id='7' class='header'>7. Sample Keys</div>
<div id='7.1' class='subheader'>7.1. Signature Key</div>
<div>
  The following key (here expressed as a JWK [<a href="https://tools.ietf.org/html/rfc7517"
                               title="RFC7517">RFC7517<img src="images/xtl.svg" alt="link"></a>]),
was used for the signature part of the <a href='#4.2'>SAD</a> sample:
</div>
   <div style='overflow-x:auto;padding-right:0.2em'>
    <div class="staticbox" style='min-width:35em'>
      {<br>&nbsp;&nbsp;&quot;kty&quot;:&nbsp;&quot;EC&quot;,<br>&nbsp;&nbsp;&quot;crv&quot;:&nbsp;&quot;P-256&quot;,<br>&nbsp;&nbsp;&quot;x&quot;:&nbsp;&quot;6BKxpty8cI-exDzCkh-goU6dXq3MbcY0cd1LaAxiNrU&quot;,<br>&nbsp;&nbsp;&quot;y&quot;:&nbsp;&quot;mCbcvUzm44j3Lt2b5BPyQloQ91tf2D2V-gzeUxWaUdg&quot;,<br>&nbsp;&nbsp;&quot;d&quot;:&nbsp;&quot;6XxMFXhcYT5QN9w5TIg2aSKsbcj-pj4BnZkK7ZOt4B8&quot;<br>}<br>
    </div>
   </div>
<div>Note that ES256 signatures usually depend on a random factor as well, making
each signature unique.  Verification should still work
as long as the signature key and data to be signed remain constant.
</div>
<div id='7.2' class='subheader'>7.2. Encryption Key</div>
<div>
  The following key (here expressed as a JWK [<a href="https://tools.ietf.org/html/rfc7517"
                                   title="RFC7517">RFC7517<img src="images/xtl.svg" alt="link"></a>]),
was used for the encryption part of the <a href='#5'>ESAD</a> sample:
</div>
  <div style='overflow-x:auto;padding-right:0.2em'>
    <div class="staticbox" style='min-width:35em'>
      {<br>&nbsp;&nbsp;&quot;kty&quot;:&nbsp;&quot;OKP&quot;,<br>&nbsp;&nbsp;&quot;crv&quot;:&nbsp;&quot;X25519&quot;,<br>&nbsp;&nbsp;&quot;x&quot;:&nbsp;&quot;6ZoM7yBYlJYNmxwFl4UT3MtCoTv7ztUjpRuKEXrV8Aw&quot;,<br>&nbsp;&nbsp;&quot;d&quot;:&nbsp;&quot;cxfl86EVmcqrR07mWENCf1F_5Ni5mt1ViGyERB6Q1vA&quot;<br>}<br>
    </div>
   </div>
<div>
Note that the ESAD sample uses a <code>keyId</code> for identifying the encryption key.
</div>
<div id='documenthistory' class='header'>Document History</div>
<div style='overflow-x:auto;padding-right:0.2em'>
<table class="tftable">
<tr><th>Date</th><th>Version</th><th style="min-width:30em">Comment</th></tr>
<tr>
<td style="text-align:center;white-space:nowrap">2021-07-26</td>
<td style="text-align:center">0.1</td><td>Initial publishing.</td>
</tr>
<tr>
<td style="text-align:center;white-space:nowrap">2021-08-23</td>
<td style="text-align:center">0.11</td><td>Added CTAP2 suggestion.</td>
</tr>
<tr>
<td style="text-align:center;white-space:nowrap">2021-09-30</td>
<td style="text-align:center">0.12</td><td>Made <code>keyId</code> generic.</td>
</tr>
<tr>
<td style="text-align:center;white-space:nowrap">2022-02-02</td>
<td style="text-align:center">0.13</td><td>Main document update forced test data update.</td>
</tr>
<tr>
<td style="text-align:center;white-space:nowrap">2022-06-17</td>
<td style="text-align:center">0.14</td><td>CBOR primitives expressed in CDDL notation.</td>
</tr>
<tr>
<td style="text-align:center;white-space:nowrap">2022-08-18</td>
<td style="text-align:center">0.15</td><td>CTAP2 signature scheme.</td>
</tr>
</table>
</div>
 <div id='authors' class='header'>Authors</div>
       <div>
        The FWP specification is currently authored by Anders Rundgren
        (anders.rundgren.net@gmail.com) on GitHub
          (<a href="https://github.com/fido-web-pay/specification"
             title="GitHub">https://github.com/fido-web-pay/specification<img src="images/xtl.svg" alt="link"></a>).
      </div>
 <div id='trademarks' class='header'>Trademarks</div>
      <div>
        FIDO is a registered trademark of the FIDO alliance.<br />
        EMV is a registered trademark of EMVCo.<br />&nbsp;<br />
        This specification represents an <i>independent effort</i>,
        not associated with the FIDO alliance or EMVCo.
      </div>
</body></html>
